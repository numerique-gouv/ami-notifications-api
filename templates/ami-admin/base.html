<!doctype html>
<html lang="en">
  <head>
    <title>Rendez-Vous Officiel</title>
    <meta charset="UTF-8" />
    <link rel="icon" href="/favicon.ico" sizes="32x32">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="manifest" href="/manifest.json" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/ami_admin/static/dsfr/dist/dsfr.min.css" />
    <link rel="stylesheet" href="/ami_admin/static/dsfr/dist/utility/utility.min.css" />
    {% block style %}
      <style>
        .container {
          background-color: var(--background-alt-grey);

          .fr-container {
            padding-top: 24px;
            margin-bottom: 68px;

            .fr-connect-group {
              .fr-connect, p {
                display: flex;
                flex-direction: column;
                align-items: center;
                width: 100%;
              }
              .fr-connect:before {
                width: 3.375em !important;
                background-size: 3.375em 3em !important;
                left: 0.625em !important;
                background-image: url("./icons/pro-connect-logo.svg") !important;
              }
            }
          }

          nav.menu-footer {
            position: fixed;
            z-index: 2;
            bottom: 0;
            background: var(--background-default-grey);
            border-top: solid 1px var(--background-alt-grey-active);
            width: 100%;
            .menu-list {
              display: flex;
              list-style-type: none;
              padding-inline-start: 0;
              margin-block-start: 0;
              margin-block-end: 0;
            }
            .menu__item {
              padding-bottom: 0;
              width: 100%;
              .menu__link {
                position: relative;
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                background: none;
                padding: .75rem 0 .375rem;
                height: 4.25rem;
                span {
                  display: block;
                  width: 100%;
                  color: var(--grey-200-850);
                  text-align: center;
                  font-size: .75rem;
                  font-weight: 400;
                  line-height: 1.25rem;
                  &.menu__icon {
                    color: var(--blue-france-sun-113-625);
                  }
                }
              }
            }
          }
        }
      </style>
    {% endblock style %}
    <script lang="ts">
      const proConnect = async () => {
        const STATE = 'state-not-implemented-yet-and-has-more-than-32-chars'
        const NONCE = 'not-implemented-yet-and-has-more-than-32-chars'

        const query = {
          scope: 'openid identite_pivot preferred_username email',
          redirect_uri: '{{ PUBLIC_PRO_CONNECT_AMI_ADMIN_REDIRECT_URL }}',
          response_type: 'code',
          client_id: '{{ PUBLIC_PRO_CONNECT_AMI_ADMIN_CLIENT_ID }}',
          state: STATE,
          nonce: NONCE,
          acr_values: 'eidas1',
          prompt: 'login',
        }

        const url = `{{ PUBLIC_PRO_CONNECT_BASE_URL }}{{ PUBLIC_PRO_CONNECT_AUTHORIZATION_ENDPOINT }}`
        const params = new URLSearchParams(query).toString()

        window.location.href = `${url}?${params}`

        return Response.redirect(`${url}?${params}`)
      }
    </script>

  </head>
  <body>
    <main class="container {% if not isProConnected %}not-connected{% endif %}">
      {% block out_wrapper %}
        <div class="fr-container">
          {% block wrapper %}
            {% if not isProConnected %}
              <div class="homepage-not-connected">
                {% block not_connected_container %}
                  <p>
                    Pour accéder à l'interface d'administration d'AMI :
                  </p>
                  <div class="fr-connect-group">
                    <button
                      class="fr-connect"
                      type="button"
                      id="fr-connect-button"
                      onclick="proConnect()"
                    >
                      <span class="fr-connect__login">S’identifier avec</span>
                      <span class="fr-connect__brand">ProConnect</span>
                    </button>
                    <p>
                      <a href="https://www.proconnect.gouv.fr/"
                         target="_blank"
                         rel="noopener"
                         title="Qu’est-ce que ProConnect ? - nouvelle fenêtre"
                      >
                        Qu’est-ce que ProConnect ?
                      </a>
                    </p>
                  </div>
                {% endblock not_connected_container %}
              </div>
            {% else %}
              <div>
                <h1>Administration d'AMI</h1>
              </div>
              <div class="wrapper">
                {% block container %}{% endblock container %}
                <form action="/ami_admin/logout" class="fr-connect-logout">
                  <button type="submit">
                    <span>Me déconnecter</span>
                  </button>
                </form>
              </div>
            {% endif %}
          {% endblock wrapper %}
        </div>
        {% if isProConnected %}
          <nav class="menu-footer {% block footer_nav_current %}{% endblock %}"
               aria-label="Menu principal">
            <ul class="menu-list">
              <li class="menu__item">
                <a class="menu__link" href="/ami_admin">
                  <span class="menu__icon fr-icon-calendar-event-fill" aria-hidden="true"></span>
                  <span>Rendez-vous</span>
                </a>
              </li>
              <li class="menu__item">
                <a class="menu__link menu__link_test" href="/ami_admin/test">
                  <span class="menu__icon fr-icon-test-tube-fill" aria-hidden="true"></span>
                  <span>Tester</span>
                </a>
              </li>
            </ul>
          </nav>
        {% endif %}
      {% endblock out_wrapper %}
    </main>
    {% block extra_body %}{% endblock extra_body %}
    <script type="module" src="/ami_admin/static/dsfr/dist/dsfr.module.min.js"></script>
    <script type="text/javascript" nomodule src="/ami_admin/static/dsfr/dist/dsfr.nomodule.min.js"></script>
  </body>
</html>
