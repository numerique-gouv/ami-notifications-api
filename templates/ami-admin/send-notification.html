{% extends "ami-admin/base.html" %}

{% block style %}
  {{ super() }}
  <style>
    nav.ami-admin-nav {
      margin-bottom: 2rem;
    }
    .notifications--item {
      span {
        color: var(--text-disabled-grey);
        font-size: 12px;
      }
    }
  </style>
{% endblock style %}

{% block footer_nav_current %}test{% endblock %}

{% block wrapper %}
  <nav class="ami-admin-nav">
    <a href="/ami_admin" class="fr-link">
      <span>Retour à l'accueil</span>
    </a>
  </nav>

  <h2>Envoyer une notification à {{ user.name }}</h2>

  <form class="fr-pb-4v" action="" method="post">
    <div class="fr-input-group">
      <label class="fr-label" for="send-notification-title-input">Titre</label>
      <input class="fr-input" aria-describedby="input-title-messages" id="send-notification-title-input" type="text">
      <div class="fr-messages-group" id="input-title-messages" aria-live="polite">
      </div>
    </div>
    <div class="fr-input-group">
      <label class="fr-label" for="send-notification-message-input">Message</label>
      <input class="fr-input" aria-describedby="input-message-messages" id="send-notification-message-input" type="text">
      <div class="fr-messages-group" id="input-message-messages" aria-live="polite">
      </div>
    </div>
    <div class="fr-input-group">
      <label class="fr-label" for="send-notification-sender-input">Expéditeur</label>
      <input class="fr-input" aria-describedby="input-sender-messages" id="send-notification-sender-input" type="text">
      <div class="fr-messages-group" id="input-sender-messages" aria-live="polite">
      </div>
    </div>

    <button class="fr-btn" type="submit" id="send-notification-button" onclick="sendNotification()">
      Envoyer
    </button>
    <span id="send-notification-status"></span>
  </form>

  {% if notifications %}
    <h3>Historique des notifications</h3>
    <ul class="notifications">
      {% for notification in notifications %}
        <li class="notifications--item">#{{ notification.id }} {{ notification.title }} - {{ notification.message }} <span>envoyé par: {{ notification.sender }}, le {{ notification.created_at.strftime('%d/%m/%Y %H:%M:%S') }}</span></li>
      {% endfor %}
    </ul>
  {% endif %}
{% endblock wrapper %}

{% block extra_body %}
  <script lang="ts">
    const sendNotification = async () => {
      const notifyTitleInput = document.querySelector('#send-notification-title-input')
      const notifyMessageInput = document.querySelector('#send-notification-message-input')
      const notifySenderInput = document.querySelector('#send-notification-sender-input')
      const notifyMessageBtn = document.querySelector('#send-notification-button')
      const notifyMessageStatus = document.querySelector('#send-notification-status')

      const payload = {
        title: notifyTitleInput.value,
        message: notifyMessageInput.value,
        sender: notifySenderInput.value,
        user_id: '{{ user.id }}',
      }
      console.log(payload)
      console.log('notifying a message')
      notifyMessageBtn.disabled = true
      notifyMessageStatus.innerText = 'Notifying...'
      document.querySelectorAll('.fr-messages-group').forEach((element) => element.innerHTML = '')
      const response = await fetch('/ami_admin/notifications', {
        method: 'POST',
        body: JSON.stringify(payload),
      })
      console.log('response from AMI:', response)
      notifyMessageBtn.disabled = false
      if (response.status < 400) {
        notifyMessageStatus.innerText = 'Done!'
      } else {
        const json_response = await response.json()
        if (json_response.extra) {
          const errors = json_response.extra
          errors.forEach((error) => {
            const notifyMessages = document.querySelector(`#input-${error.key}-messages`)
            notifyMessages.innerHTML = `<p class="fr-message fr-message--error">${error.message}</p>`
          })
          notifyMessageStatus.innerText = ''
        } else {
          notifyMessageStatus.innerText = `error ${response.status}: ${response.statusText}, ${response.body}`
        }
      }
    }
  </script>
{% endblock extra_body %}
