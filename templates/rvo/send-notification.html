{% extends "rvo/base.html" %}

{% block style %}
  <style>
    .container > * {
      padding: 24px 16px;
    }

    nav .back-link {
      margin-bottom: 24px;
    }
    nav .back-link a {
      text-decoration: none;
      --underline-img: none;
    }
  </style>
{% endblock style %}

{% block wrapper %}
  <nav>
    <div class="back-link">
      <a href="/rvo" title="Retour à la page d'accueil">
        <span aria-hidden="true" class="fr-icon-arrow-left-line"></span>
      </a>
    </div>
  </nav>

  <h2>Envoyer une notification</h2>

  <form action="" method="post">
    <div class="fr-select-group">
      <label class="fr-label" for="user-id">Usager</label>
      <select class="fr-select" aria-describedby="select-hint-messages" id="user-id" name="user-id">
        {% for user in users %}
          <option value="{{ user.id }}">{{ user.email }}</option>
        {% endfor %}
      </select>
      <div class="fr-messages-group" id="select-hint-messages" aria-live="polite">
      </div>
    </div>
    <div class="fr-input-group">
      <label class="fr-label" for="send-notification-title-input">Titre</label>
      <input class="fr-input" aria-describedby="input-messages" id="send-notification-title-input" type="text">
      <div class="fr-messages-group" id="input-messages" aria-live="polite">
      </div>
    </div>
    <div class="fr-input-group">
      <label class="fr-label" for="send-notification-message-input">Message</label>
      <input class="fr-input" aria-describedby="input-messages" id="send-notification-message-input" type="text">
      <div class="fr-messages-group" id="input-messages" aria-live="polite">
      </div>
    </div>
    <div class="fr-input-group">
      <label class="fr-label" for="send-notification-sender-input">Expéditeur</label>
      <input class="fr-input" aria-describedby="input-messages" id="send-notification-sender-input" type="text">
      <div class="fr-messages-group" id="input-messages" aria-live="polite">
      </div>
    </div>

    <button class="fr-btn" type="submit" id="send-notification-button" onclick="sendNotification()">
      Envoyer
    </button>
    <span id="send-notification-status"></span>
  </form>
{% endblock wrapper %}

{% block extra_body %}
  <script lang="ts">
    const sendNotification = async () => {
      const userIdInput = document.querySelector('#user-id')
      const notifyTitleInput = document.querySelector('#send-notification-title-input')
      const notifyMessageInput = document.querySelector('#send-notification-message-input')
      const notifySenderInput = document.querySelector('#send-notification-sender-input')
      const notifyMessageBtn = document.querySelector('#send-notification-button')
      const notifyMessageStatus = document.querySelector('#send-notification-status')

      const payload = {
        title: notifyTitleInput.value,
        message: notifyMessageInput.value,
        sender: notifySenderInput.value,
        user_id: userIdInput.value,
      }
      console.log(payload)
      console.log('notifying a message')
      notifyMessageBtn.disabled = true
      notifyMessageStatus.innerText = 'Notifying...'
      const response = await fetch('/api/v1/notifications', {
        method: 'POST',
        body: JSON.stringify(payload),
      })
      console.log('response from AMI:', response)
      notifyMessageBtn.disabled = false
      if (response.status < 400) {
        notifyMessageStatus.innerText = 'Done!'
      } else {
        notifyMessageStatus.innerText = `error ${response.status}: ${response.statusText}, ${response.body}`
      }
    }
  </script>
{% endblock extra_body %}
